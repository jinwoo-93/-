// prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ==================== 사용자 ====================

model User {
  id                 String    @id @default(cuid())
  email              String?   @unique
  password           String?   // 해시된 비밀번호
  phone              String?   @unique
  phoneCountry       String?   // KR, CN
  name               String?
  nickname           String?   @unique
  profileImage       String?
  userType           UserType  @default(BUYER)
  country            Country   @default(KR)
  language           Language  @default(KO)
  marketingAgreed    Boolean   @default(false)

  // NextAuth 필드
  emailVerified      DateTime?
  image              String?
  accounts           Account[]
  sessions           Session[]

  // 인증 정보
  isPhoneVerified    Boolean   @default(false)
  phoneVerified      DateTime?
  isIdentityVerified Boolean   @default(false)
  identityVerifiedAt DateTime?
  isBusinessVerified Boolean   @default(false)
  businessVerifiedAt DateTime?
  businessNumber     String?
  businessName       String?
  businessLicenseUrl String?

  // 뱃지
  hasExcellentBadge  Boolean   @default(false)
  badgeAwardedAt     DateTime?

  // FCM 푸시 알림
  fcmToken           String?
  fcmTokenUpdatedAt  DateTime?

  // 통계
  totalSales         Int       @default(0)
  totalPurchases     Int       @default(0)
  averageRating      Float     @default(0)
  disputeRate        Float     @default(0)

  // 관계
  posts              Post[]
  ordersAsBuyer      Order[]   @relation("BuyerOrders")
  ordersAsSeller     Order[]   @relation("SellerOrders")
  reviews            Review[]
  receivedReviews    Review[]  @relation("ReceivedReviews")
  bids               AdBid[]
  disputes           Dispute[]
  votes              DisputeVote[]
  messages           Message[] @relation("SentMessages")
  receivedMessages   Message[] @relation("ReceivedMessages")

  notificationSettings NotificationSettings?

  createdAt          DateTime  @default(now())
  updatedAt          DateTime  @updatedAt

  @@index([country, userType])
  @@index([averageRating])
}

// ==================== 알림 설정 ====================

model NotificationSettings {
  id        String @id @default(cuid())
  userId    String @unique
  user      User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // 푸시 알림 설정
  pushEnabled       Boolean @default(true)
  pushOrder         Boolean @default(true)  // 주문 관련
  pushPayment       Boolean @default(true)  // 결제 관련
  pushShipping      Boolean @default(true)  // 배송 관련
  pushChat          Boolean @default(true)  // 채팅 메시지
  pushReview        Boolean @default(true)  // 리뷰 관련
  pushDispute       Boolean @default(true)  // 분쟁 관련
  pushMarketing     Boolean @default(false) // 마케팅/광고

  // 이메일 알림 설정
  emailEnabled      Boolean @default(true)
  emailOrder        Boolean @default(true)
  emailPayment      Boolean @default(true)
  emailShipping     Boolean @default(true)
  emailReview       Boolean @default(true)
  emailDispute      Boolean @default(true)
  emailMarketing    Boolean @default(false)

  // 방해 금지 시간
  doNotDisturbStart String? // "22:00" 형식
  doNotDisturbEnd   String? // "08:00" 형식

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// ==================== 신고 ====================

model Report {
  id          String       @id @default(cuid())

  // 신고자
  reporterId  String

  // 신고 대상 (게시글 또는 사용자)
  targetType  ReportTarget
  postId      String?      // 게시글 신고 시
  targetUserId String?     // 사용자 신고 시

  // 신고 내용
  reason      ReportReason
  description String?      @db.Text
  evidence    String[]     // 증거 이미지 URL

  // 처리 상태
  status      ReportStatus @default(PENDING)
  handledBy   String?      // 처리한 관리자 ID
  handledAt   DateTime?
  resolution  String?      @db.Text // 처리 결과

  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt

  @@index([status])
  @@index([targetType, status])
  @@index([reporterId])
}

enum ReportTarget {
  POST      // 게시글 신고
  USER      // 사용자 신고
  REVIEW    // 리뷰 신고
  CHAT      // 채팅 메시지 신고
}

enum ReportReason {
  SPAM              // 스팸/도배
  FRAUD             // 사기/허위 정보
  INAPPROPRIATE     // 부적절한 콘텐츠
  COUNTERFEIT       // 위조/불법 상품
  HARASSMENT        // 욕설/비방
  PROHIBITED_ITEM   // 금지 품목
  OTHER             // 기타
}

enum ReportStatus {
  PENDING    // 대기
  REVIEWING  // 검토 중
  RESOLVED   // 처리 완료
  DISMISSED  // 기각
}

// ==================== 찜하기/위시리스트 ====================

model Wishlist {
  id        String   @id @default(cuid())
  userId    String
  postId    String

  createdAt DateTime @default(now())

  @@unique([userId, postId])
  @@index([userId])
  @@index([postId])
}

// ==================== 팔로우 ====================

model Follow {
  id          String   @id @default(cuid())
  followerId  String   // 팔로우하는 사람
  followingId String   // 팔로우 당하는 사람 (판매자)

  createdAt   DateTime @default(now())

  @@unique([followerId, followingId])
  @@index([followerId])
  @@index([followingId])
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

// ==================== SMS 인증 ====================

model VerificationCode {
  id        String   @id @default(cuid())
  phone     String
  code      String
  expiresAt DateTime
  createdAt DateTime @default(now())

  @@index([phone, code])
  @@index([expiresAt])
}

enum UserType {
  BUYER
  SELLER
  BOTH
  SHIPPING
  ADMIN
}

enum Country {
  KR
  CN
}

enum Language {
  KO
  ZH
}

// ==================== 게시글 ====================

model Post {
  id              String         @id @default(cuid())
  userId          String
  user            User           @relation(fields: [userId], references: [id])

  postType        PostType
  tradeDirection  TradeDirection

  title           String
  titleZh         String?        // 중국어 제목
  description     String         @db.Text
  descriptionZh   String?        @db.Text // 중국어 설명

  categoryId      String
  category        Category       @relation(fields: [categoryId], references: [id])

  priceKRW        Int
  priceCNY        Float
  quantity        Int            @default(1)

  images          String[]       // URL 배열

  status          PostStatus     @default(ACTIVE)
  viewCount       Int            @default(0)

  // 통계
  salesCount      Int            @default(0)
  reorderRate     Float          @default(0)

  orders          Order[]

  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt
  expiresAt       DateTime?

  @@index([categoryId, status])
  @@index([userId])
  @@index([salesCount])
  @@index([createdAt])
  @@index([tradeDirection, status])
}

enum PostType {
  SELL
  BUY
}

enum TradeDirection {
  KR_TO_CN  // 한국 → 중국 (역직구)
  CN_TO_KR  // 중국 → 한국 (직구)
}

enum PostStatus {
  ACTIVE
  SOLD_OUT
  EXPIRED
  HIDDEN
  DELETED
}

// ==================== 카테고리 ====================

model Category {
  id          String     @id @default(cuid())
  nameKo      String
  nameZh      String
  slug        String     @unique
  icon        String?
  parentId    String?
  parent      Category?  @relation("CategoryChildren", fields: [parentId], references: [id])
  children    Category[] @relation("CategoryChildren")
  posts       Post[]
  adSlots     AdSlot[]

  createdAt   DateTime   @default(now())

  @@index([parentId])
}

// ==================== 주문 ====================

model Order {
  id                String           @id @default(cuid())
  orderNumber       String           @unique

  postId            String
  post              Post             @relation(fields: [postId], references: [id])

  buyerId           String
  buyer             User             @relation("BuyerOrders", fields: [buyerId], references: [id])

  sellerId          String
  seller            User             @relation("SellerOrders", fields: [sellerId], references: [id])

  quantity          Int

  // 금액
  itemPriceKRW      Int
  itemPriceCNY      Float
  shippingFeeKRW    Int
  shippingFeeCNY    Float
  platformFeeKRW    Int
  platformFeeCNY    Float
  totalKRW          Int
  totalCNY          Float

  // 수수료율 (사업자: 3%, 일반: 5%)
  feeRate           Float

  // 배송 정보
  shippingCompanyId String?
  shippingCompany   ShippingCompany? @relation(fields: [shippingCompanyId], references: [id])
  trackingNumber    String?

  // 주소
  shippingAddress   Json

  // 상태
  status            OrderStatus      @default(PENDING_PAYMENT)

  // 발송 전 사진 (분쟁 증거)
  preShipPhotos     String[]

  // 타임스탬프
  paidAt            DateTime?
  shippedAt         DateTime?
  deliveredAt       DateTime?
  confirmedAt       DateTime?

  payment           Payment?
  dispute           Dispute?
  reviews           Review[]

  createdAt         DateTime         @default(now())
  updatedAt         DateTime         @updatedAt

  @@index([buyerId, status])
  @@index([sellerId, status])
  @@index([status])
}

enum OrderStatus {
  PENDING_PAYMENT   // 결제 대기
  PAID              // 결제 완료 (에스크로 보관)
  SHIPPING          // 배송 중
  DELIVERED         // 배송 완료
  CONFIRMED         // 구매 확정
  DISPUTED          // 분쟁 중
  REFUNDED          // 환불 완료
  CANCELLED         // 취소
}

// ==================== 결제 ====================

model Payment {
  id               String        @id @default(cuid())
  orderId          String        @unique
  order            Order         @relation(fields: [orderId], references: [id])

  paymentMethod    PaymentMethod
  paymentGateway   String        // stripe, tosspayments, alipay 등
  transactionId    String?

  amountKRW        Int
  amountCNY        Float
  currency         String        // KRW, CNY

  status           PaymentStatus @default(PENDING)

  // 에스크로
  escrowReleasedAt DateTime?

  createdAt        DateTime      @default(now())
  updatedAt        DateTime      @updatedAt

  @@index([status])
}

enum PaymentMethod {
  NAVER_PAY
  KAKAO_PAY
  ALIPAY
  WECHAT_PAY
  PAYPAL
  CREDIT_CARD
}

enum PaymentStatus {
  PENDING
  COMPLETED
  ESCROW_HELD
  RELEASED
  REFUNDED
  FAILED
}

// ==================== 분쟁 ====================

model Dispute {
  id              String          @id @default(cuid())
  orderId         String          @unique
  order           Order           @relation(fields: [orderId], references: [id])

  initiatorId     String
  initiator       User            @relation(fields: [initiatorId], references: [id])

  reason          String
  description     String          @db.Text
  evidence        String[]        // 증거 이미지 URL

  status          DisputeStatus   @default(OPEN)

  // 투표 결과
  votesForBuyer   Int             @default(0)
  votesForSeller  Int             @default(0)

  // 최종 결정
  buyerRefundRate Float?          // 구매자 환불 비율 (0~100%)

  votes           DisputeVote[]

  resolvedAt      DateTime?
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt
}

enum DisputeStatus {
  OPEN
  VOTING
  RESOLVED
  APPEALED
}

model DisputeVote {
  id          String    @id @default(cuid())
  disputeId   String
  dispute     Dispute   @relation(fields: [disputeId], references: [id])

  voterId     String
  voter       User      @relation(fields: [voterId], references: [id])

  voteFor     VoteFor   // BUYER or SELLER
  comment     String?

  createdAt   DateTime  @default(now())

  @@unique([disputeId, voterId])
  @@index([disputeId])
}

enum VoteFor {
  BUYER
  SELLER
}

// ==================== 리뷰 ====================

model Review {
  id            String    @id @default(cuid())
  orderId       String
  order         Order     @relation(fields: [orderId], references: [id])

  reviewerId    String
  reviewer      User      @relation(fields: [reviewerId], references: [id])

  revieweeId    String
  reviewee      User      @relation("ReceivedReviews", fields: [revieweeId], references: [id])

  rating        Int       // 1-5
  comment       String?   @db.Text
  images        String[]

  createdAt     DateTime  @default(now())

  @@unique([orderId, reviewerId])
  @@index([revieweeId, rating])
}

// ==================== 배송업체 ====================

model ShippingCompany {
  id                 String           @id @default(cuid())

  name               String
  nameZh             String
  logo               String?
  description        String?          @db.Text

  // 인증
  businessLicenseUrl String
  isVerified         Boolean          @default(false)

  // 서비스 지역
  serviceRoutes      Json             // [{from: 'KR', to: 'CN'}, ...]

  // 가격 정보
  pricePerKg         Int?             // KRW
  minimumFee         Int?             // 최소 배송비

  // 통계
  totalShipments     Int              @default(0)
  damageRate         Float            @default(0)
  lossRate           Float            @default(0)
  onTimeRate         Float            @default(100)
  averageRating      Float            @default(0)

  // 뱃지
  hasExcellentBadge  Boolean          @default(false)

  orders             Order[]
  bids               ShippingAdBid[]
  reviews            ShippingReview[]

  createdAt          DateTime         @default(now())
  updatedAt          DateTime         @updatedAt

  @@index([isVerified, averageRating])
}

model ShippingReview {
  id              String          @id @default(cuid())
  companyId       String
  company         ShippingCompany @relation(fields: [companyId], references: [id])

  userId          String

  rating          Int             // 1-5

  // 세부 평가
  deliverySpeed   Int             // 1-5
  packaging       Int             // 1-5
  communication   Int             // 1-5

  isDamaged       Boolean         @default(false)
  isLost          Boolean         @default(false)
  isOnTime        Boolean         @default(true)

  comment         String?         @db.Text

  createdAt       DateTime        @default(now())

  @@index([companyId])
}

// ==================== 광고 입찰 ====================

model AdSlot {
  id           String          @id @default(cuid())
  categoryId   String
  category     Category        @relation(fields: [categoryId], references: [id])

  slotType     SlotType        // PRODUCT or SHIPPING
  position     Int             // 1, 2, 3 (상위 3개)

  bids         AdBid[]
  shippingBids ShippingAdBid[]

  @@unique([categoryId, slotType, position])
}

enum SlotType {
  PRODUCT
  SHIPPING
}

model AdBid {
  id          String    @id @default(cuid())
  slotId      String
  slot        AdSlot    @relation(fields: [slotId], references: [id])

  userId      String
  user        User      @relation(fields: [userId], references: [id])

  postId      String?   // 광고할 게시글

  bidAmount   Int       // 입찰가 (원)

  weekStart   DateTime  // 해당 주 시작일
  weekEnd     DateTime  // 해당 주 종료일

  status      BidStatus @default(PENDING)

  isWinner    Boolean   @default(false)
  winPosition Int?      // 1, 2, 3

  createdAt   DateTime  @default(now())

  @@index([slotId, weekStart])
  @@index([userId])
}

model ShippingAdBid {
  id          String          @id @default(cuid())
  slotId      String
  slot        AdSlot          @relation(fields: [slotId], references: [id])

  companyId   String
  company     ShippingCompany @relation(fields: [companyId], references: [id])

  bidAmount   Int

  weekStart   DateTime
  weekEnd     DateTime

  status      BidStatus       @default(PENDING)

  isWinner    Boolean         @default(false)
  winPosition Int?

  createdAt   DateTime        @default(now())

  @@index([slotId, weekStart])
  @@index([companyId])
}

enum BidStatus {
  PENDING   // 입찰 진행 중
  WON       // 낙찰
  LOST      // 패찰 (환불 처리)
  REFUNDED  // 환불 완료
}

// ==================== 채팅 ====================

model ChatRoom {
  id            String    @id @default(cuid())

  // 참여자 (항상 2명)
  participant1Id String
  participant2Id String

  // 관련 주문 (있는 경우)
  orderId       String?

  // 마지막 메시지 정보 (성능 최적화)
  lastMessage   String?
  lastMessageAt DateTime?

  messages      Message[]

  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@unique([participant1Id, participant2Id])
  @@index([participant1Id])
  @@index([participant2Id])
}

model Message {
  id          String    @id @default(cuid())

  chatRoomId  String?
  chatRoom    ChatRoom? @relation(fields: [chatRoomId], references: [id])

  senderId    String
  sender      User      @relation("SentMessages", fields: [senderId], references: [id])

  receiverId  String
  receiver    User      @relation("ReceivedMessages", fields: [receiverId], references: [id])

  content     String    @db.Text
  images      String[]

  messageType MessageType @default(TEXT)

  isRead      Boolean   @default(false)
  readAt      DateTime?

  createdAt   DateTime  @default(now())

  @@index([chatRoomId, createdAt])
  @@index([senderId, receiverId])
  @@index([receiverId, isRead])
}

enum MessageType {
  TEXT
  IMAGE
  SYSTEM
}

// ==================== 환율 ====================

model ExchangeRate {
  id           String   @id @default(cuid())
  fromCurrency String
  toCurrency   String
  rate         Float
  updatedAt    DateTime @default(now())

  @@unique([fromCurrency, toCurrency])
}

// ==================== 알림 ====================

model Notification {
  id        String           @id @default(cuid())
  userId    String
  type      NotificationType
  title     String
  message   String
  link      String?
  isRead    Boolean          @default(false)
  createdAt DateTime         @default(now())

  @@index([userId, isRead])
}

enum NotificationType {
  ORDER
  PAYMENT
  SHIPPING
  DISPUTE
  REVIEW
  SYSTEM
  SUPPORT
}

// ==================== 고객 문의 ====================

model SupportTicket {
  id          String         @id @default(cuid())

  // 문의자 정보 (로그인 사용자 또는 비회원)
  userId      String?
  email       String
  name        String
  phone       String?

  // 문의 내용
  category    SupportCategory
  subject     String
  content     String         @db.Text
  attachments String[]       // 첨부파일 URL

  // 관련 주문 (있는 경우)
  orderId     String?

  // 상태
  status      SupportStatus  @default(OPEN)
  priority    SupportPriority @default(NORMAL)

  // 담당자
  assignedTo  String?

  // 응답
  responses   SupportResponse[]

  // 타임스탬프
  resolvedAt  DateTime?
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt

  @@index([userId])
  @@index([status])
  @@index([category])
  @@index([createdAt])
}

model SupportResponse {
  id          String        @id @default(cuid())
  ticketId    String
  ticket      SupportTicket @relation(fields: [ticketId], references: [id], onDelete: Cascade)

  // 응답자 (관리자 또는 고객)
  responderId String
  isAdmin     Boolean       @default(false)

  content     String        @db.Text
  attachments String[]

  createdAt   DateTime      @default(now())

  @@index([ticketId])
}

enum SupportCategory {
  ORDER           // 주문/결제
  SHIPPING        // 배송
  REFUND          // 환불/취소
  ACCOUNT         // 계정
  TECHNICAL       // 기술 문제
  REPORT          // 신고
  SUGGESTION      // 제안/건의
  OTHER           // 기타
}

enum SupportStatus {
  OPEN            // 접수
  IN_PROGRESS     // 처리 중
  WAITING_REPLY   // 답변 대기 (고객 응답 대기)
  RESOLVED        // 해결됨
  CLOSED          // 종료
}

enum SupportPriority {
  LOW
  NORMAL
  HIGH
  URGENT
}

// ==================== 검색 기록 ====================

model SearchHistory {
  id          String   @id @default(cuid())
  keyword     String
  resultCount Int      @default(0)
  createdAt   DateTime @default(now())

  @@index([keyword])
  @@index([createdAt])
}

// ==================== 상품 Q&A ====================

model ProductQA {
  id          String        @id @default(cuid())
  postId      String
  userId      String        // 질문자

  question    String        @db.Text
  questionZh  String?       @db.Text // 중국어 질문
  isPrivate   Boolean       @default(false) // 비공개 문의

  answer      String?       @db.Text
  answerZh    String?       @db.Text
  answeredAt  DateTime?
  answeredBy  String?       // 답변자 (판매자)

  status      QAStatus      @default(PENDING)

  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  @@index([postId, status])
  @@index([userId])
  @@index([answeredBy])
}

enum QAStatus {
  PENDING     // 답변 대기
  ANSWERED    // 답변 완료
  DELETED     // 삭제됨
}

// ==================== 포인트 시스템 ====================

model UserPoint {
  id          String       @id @default(cuid())
  userId      String       @unique
  balance     Int          @default(0) // 현재 잔액
  totalEarned Int          @default(0) // 총 적립
  totalUsed   Int          @default(0) // 총 사용

  history     PointHistory[]

  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
}

model PointHistory {
  id            String      @id @default(cuid())
  userPointId   String
  userPoint     UserPoint   @relation(fields: [userPointId], references: [id], onDelete: Cascade)

  type          PointType
  amount        Int         // 양수: 적립, 음수: 사용
  balance       Int         // 변경 후 잔액
  description   String
  descriptionZh String?

  // 관련 정보
  orderId       String?
  disputeId     String?
  couponId      String?

  expiresAt     DateTime?
  isExpired     Boolean     @default(false)

  createdAt     DateTime    @default(now())

  @@index([userPointId, createdAt])
  @@index([type])
}

enum PointType {
  VOTE_REWARD     // 분쟁 투표 보상
  SIGNUP_BONUS    // 가입 보너스
  ORDER_REWARD    // 구매 적립
  REVIEW_REWARD   // 리뷰 작성 보상
  REFERRAL_REWARD // 추천인 보상
  COUPON_EXCHANGE // 쿠폰 전환
  ORDER_USE       // 주문시 사용
  ADMIN_ADJUST    // 관리자 조정
  EXPIRED         // 만료
}

// ==================== 쿠폰 시스템 ====================

model Coupon {
  id              String        @id @default(cuid())
  code            String        @unique
  name            String
  nameZh          String?

  discountType    DiscountType
  discountValue   Int
  minOrderAmount  Int           @default(0)
  maxDiscount     Int?

  totalQuantity   Int           @default(0)
  usedQuantity    Int           @default(0)
  isActive        Boolean       @default(true)

  validFrom       DateTime      @default(now())
  validUntil      DateTime
  usageLimit      Int           @default(1)

  categoryId      String?
  sellerId        String?
  tradeDirection  String?

  userCoupons     UserCoupon[]

  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  @@index([code])
  @@index([isActive, validUntil])
}

model UserCoupon {
  id          String        @id @default(cuid())
  userId      String
  couponId    String
  coupon      Coupon        @relation(fields: [couponId], references: [id])

  status      CouponStatus  @default(AVAILABLE)
  usedAt      DateTime?
  orderId     String?

  createdAt   DateTime      @default(now())

  @@unique([userId, couponId])
  @@index([userId, status])
}

enum DiscountType {
  FIXED
  PERCENTAGE
}

enum CouponStatus {
  AVAILABLE
  USED
  EXPIRED
}

// ==================== 라이브 커머스 ====================

model LiveStream {
  id            String       @id @default(cuid())
  hostId        String

  title         String
  titleZh       String?
  description   String?      @db.Text
  descriptionZh String?      @db.Text
  thumbnail     String?

  streamKey     String       @unique
  streamUrl     String?
  status        LiveStatus   @default(SCHEDULED)

  scheduledAt   DateTime?
  startedAt     DateTime?
  endedAt       DateTime?

  viewerCount   Int          @default(0)
  peakViewers   Int          @default(0)
  totalViews    Int          @default(0)

  products      LiveProduct[]

  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt

  @@index([hostId, status])
  @@index([status, scheduledAt])
}

model LiveProduct {
  id          String     @id @default(cuid())
  streamId    String
  stream      LiveStream @relation(fields: [streamId], references: [id], onDelete: Cascade)
  postId      String

  livePrice   Int?
  livePriceCNY Float?
  displayOrder Int       @default(0)

  clickCount  Int        @default(0)
  orderCount  Int        @default(0)

  createdAt   DateTime   @default(now())

  @@unique([streamId, postId])
  @@index([streamId])
}

enum LiveStatus {
  SCHEDULED
  LIVE
  ENDED
  CANCELLED
}

// ==================== 구매대행 요청 ====================

model PurchaseRequest {
  id              String              @id @default(cuid())
  requesterId     String

  productName     String
  productNameZh   String?
  productUrl      String?
  productImage    String?
  estimatedPrice  Int?

  quantity        Int                 @default(1)
  description     String?             @db.Text
  descriptionZh   String?             @db.Text

  maxBudget       Int?
  deadline        DateTime?

  status          PurchaseRequestStatus @default(OPEN)

  offers          PurchaseOffer[]
  selectedOfferId String?

  createdAt       DateTime            @default(now())
  updatedAt       DateTime            @updatedAt

  @@index([requesterId, status])
  @@index([status, createdAt])
}

model PurchaseOffer {
  id              String          @id @default(cuid())
  requestId       String
  request         PurchaseRequest @relation(fields: [requestId], references: [id], onDelete: Cascade)

  sellerId        String

  priceKRW        Int
  priceCNY        Float
  shippingFeeKRW  Int
  shippingFeeCNY  Float
  estimatedDays   Int

  message         String?         @db.Text
  messageZh       String?         @db.Text

  status          OfferStatus     @default(PENDING)

  createdAt       DateTime        @default(now())

  @@unique([requestId, sellerId])
  @@index([requestId])
  @@index([sellerId])
}

enum PurchaseRequestStatus {
  OPEN
  IN_PROGRESS
  COMPLETED
  CANCELLED
  EXPIRED
}

enum OfferStatus {
  PENDING
  ACCEPTED
  REJECTED
  WITHDRAWN
}
